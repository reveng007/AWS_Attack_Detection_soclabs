# 17.SOCLabs: AWS IAM User Logged into Console Without MFA

https://www.soc-labs.top/en/detections/97

## Goal: 
Write a detection rule to identify IAM user login events to the AWS Console that occurred without MFA.

## Detailed Reasoning :

1. Looking at the logs realised several things:
```yaml 
{
  "additionalEventData": {
    "LoginTo": "https://console.aws.amazon.com/console/home",
    "MFAUsed": "No",                                            <====== 1) IOC
    "MobileVersion": "No"
  },
...
```
```yaml
...
"awsRegion": "us-east-1",
  "eventCategory": "Management",
  "eventID": "e1bf1000-86a4-4a78-81d7-3e1cb123",
  "eventName": "ConsoleLogin",                                  <======= 2) IOC
  "eventSource": "signin.amazonaws.com",
  "eventTime": "2025-06-13T08:18:57Z",
  "eventType": "AwsConsoleSignIn",                              <======= 3) IOC
  "eventVersion": "1.09",
  "managementEvent": true,
  "readOnly": false,
  "recipientAccountId": "438465128930",
  "requestParameters": null,
  "responseElements": {
    "ConsoleLogin": "Success"                                   <======= 4) IOC
  },
...
```

## Sigma Query:

```yaml
title: AWS IAM User Logged into Console Without MFA
status: test
description: AWS IAM User Logged into Console Without MFA
references:
    - https://stratus-red-team.cloud/attack-techniques/AWS/aws.initial-access.console-login-without-mfa/
author: Soumyanil Biswas
date: 2025-10-18
modified: 2025-10-18
tags:
    - attack.xxxx
logsource:
    product: aws
    service: cloudtrail
detection:
    selection:
        eventSource: signin.amazonaws.com
        eventType: AwsApiCall
        
        # eventName: ConsoleLogin - without quotes when used caused issues ?
        # ChatGPT:
        # Quotes are required because without them, YAML may interpret ConsoleLogin 
        # as a boolean or variable in some parsers, leading to rule parsing errors 
        # in Sigma or SIEM tools.
        eventName: 'ConsoleLogin'

        # additionalEventData.MFAUsed: No - without quotes  when used caused issues ?
        # ChatGPT:
        # Quotes are required because without them, YAML may interpret ConsoleLogin 
        # as a boolean or variable in some parsers, leading to rule parsing errors 
        # in Sigma or SIEM tools.
        additionalEventData.MFAUsed: 'No'
        eventType: AwsConsoleSignIn
        responseElements.ConsoleLogin: Success
        
    condition: selection 
falsepositives:
    - unknown
level: high
fields:
    - eventName
    - sourceIPAddress
    - eventID
    - eventSource
    - userIdentity.arn
```

## Query Result:

<img width="1811" height="267" alt="image" src="https://github.com/user-attachments/assets/5e07b3ee-ab71-4f21-aff8-21214f2e35d5" />

------------

## When ran query without quotations:

```yaml
title: AWS IAM User Logged into Console Without MFA
status: test
description: AWS IAM User Logged into Console Without MFA
references:
    - https://stratus-red-team.cloud/attack-techniques/AWS/aws.initial-access.console-login-without-mfa/
author: Soumyanil Biswas
date: 2025-10-18
modified: 2025-10-18
tags:
    - attack.xxxx
logsource:
    product: aws
    service: cloudtrail
detection:
    selection:
        eventSource: signin.amazonaws.com
        eventType: AwsApiCall

        eventName: ConsoleLogin

        additionalEventData.MFAUsed: No
        eventType: AwsConsoleSignIn
        responseElements.ConsoleLogin: Success
        
    condition: selection 
falsepositives:
    - unknown
level: high
fields:
    - eventName
    - sourceIPAddress
    - eventID
    - eventSource
    - userIdentity.arn
```

## Query Result:

<img width="1711" height="1296" alt="image" src="https://github.com/user-attachments/assets/c34c42a2-8b13-46d5-b76e-370f3eeb7f16" />

